# @scaforge/plugin-api-orpc

ORPC plugin for Scaforge - OpenAPI-compatible RPC with excellent TypeScript support.

## Features

- ðŸ”’ **Type Safety** - End-to-end type safety from server to client
- ðŸ“– **OpenAPI Compatible** - Automatic OpenAPI specification generation
- ðŸŽ¯ **Zod Integration** - Input/output validation with Zod schemas
- ðŸš€ **Performance** - Optimized for modern web applications
- ðŸ”Œ **Integrations** - Seamless integration with auth and database plugins
- ðŸ“± **Multi-Framework** - Support for Next.js, TanStack Start, and Nuxt
- ðŸ›  **Developer Experience** - Excellent TypeScript support and tooling

## Installation

```bash
npx scaforge add api-orpc
```

## Configuration Options

- `openapi` (object, optional) - OpenAPI specification configuration
  - `title` (string, default: 'Scaforge API') - API title
  - `version` (string, default: '1.0.0') - API version
  - `description` (string, default: 'API generated by Scaforge') - API description
- `cors` (object, optional) - CORS configuration
- `playground` (boolean, default: true) - Enable API playground

## Generated Files

### Core Files
- `src/server/orpc/context.ts` - ORPC context setup
- `src/server/orpc/index.ts` - Base procedures and middleware
- `src/server/orpc/routers/index.ts` - Main router
- `src/server/orpc/routers/example.ts` - Example procedures
- `src/server/orpc/server.ts` - ORPC server setup

### Framework-Specific Files

#### Next.js
- `src/app/api/orpc/[...orpc]/route.ts` - API route handler
- `src/app/api/openapi/route.ts` - OpenAPI specification endpoint
- `src/lib/orpc/client.ts` - ORPC client setup
- `src/lib/orpc/hooks.ts` - React hooks
- `src/lib/orpc/provider.tsx` - React provider

#### Nuxt
- `plugins/orpc.client.ts` - Nuxt ORPC plugin

### Examples
- `src/components/examples/orpc-example.tsx` - Usage example

## Integrations

### With Auth Plugins
When used with `auth-authjs` or `auth-clerk`, automatically generates:
- Authentication middleware
- Protected procedures
- User context in ORPC procedures

### With Database Plugins
When used with `db-prisma`, automatically generates:
- Database client in ORPC context
- CRUD procedures for User model
- Type-safe database operations

## Usage

### Define Procedures

```typescript
// src/server/orpc/routers/posts.ts
import { z } from 'zod';
import { procedure, protectedProcedure } from '../index';

export const postsRouter = {
  getAll: procedure
    .input(z.object({
      limit: z.number().min(1).max(100).default(10),
      published: z.boolean().optional(),
    }))
    .output(z.array(z.object({
      id: z.string(),
      title: z.string(),
      content: z.string(),
      published: z.boolean(),
    })))
    .handler(async ({ input, ctx }) => {
      return ctx.prisma.post.findMany({
        take: input.limit,
        where: input.published !== undefined ? { published: input.published } : undefined,
        orderBy: { createdAt: 'desc' },
      });
    }),

  create: protectedProcedure
    .input(z.object({
      title: z.string().min(1),
      content: z.string().min(1),
    }))
    .output(z.object({
      id: z.string(),
      title: z.string(),
      content: z.string(),
    }))
    .handler(async ({ input, ctx }) => {
      return ctx.prisma.post.create({
        data: {
          ...input,
          authorId: ctx.user.id,
        },
      });
    }),
};
```

### Use in Components

```tsx
// Next.js example
import { useQuery, useMutation } from '@/lib/orpc/hooks';

function PostsList() {
  const { data: posts, isLoading } = useQuery(['posts', 'getAll'], {
    limit: 10,
    published: true,
  });

  const createPost = useMutation(['posts', 'create']);

  const handleCreate = async () => {
    await createPost.mutateAsync({
      title: 'New Post',
      content: 'Post content...',
    });
  };

  if (isLoading) return <div>Loading...</div>;

  return (
    <div>
      <button onClick={handleCreate}>Create Post</button>
      {posts?.map(post => (
        <article key={post.id}>
          <h2>{post.title}</h2>
          <p>{post.content}</p>
        </article>
      ))}
    </div>
  );
}
```

### Direct Client Usage

```typescript
// Direct client usage (no React hooks)
import { orpc } from '@/lib/orpc/client';

// Call procedures directly
const posts = await orpc.posts.getAll({
  limit: 5,
  published: true,
});

const newPost = await orpc.posts.create({
  title: 'My Post',
  content: 'Post content...',
});
```

## Key Features

### Type Safety
ORPC provides full end-to-end type safety:

```typescript
// Server procedure
export const getUser = procedure
  .input(z.object({ id: z.string() }))
  .output(z.object({
    id: z.string(),
    name: z.string(),
    email: z.string(),
  }))
  .handler(async ({ input, ctx }) => {
    // input is typed as { id: string }
    // return type must match output schema
    return ctx.prisma.user.findUnique({
      where: { id: input.id },
    });
  });

// Client usage - fully typed
const user = await orpc.users.getUser({ id: '123' });
// user is typed as { id: string; name: string; email: string; }
```

### OpenAPI Generation
Automatic OpenAPI specification generation from your procedures:

```typescript
// Access OpenAPI spec at /api/openapi
// Use with tools like Swagger UI, Postman, etc.
```

### Zod Validation
Input and output validation with Zod schemas:

```typescript
const createUserSchema = z.object({
  name: z.string().min(1).max(100),
  email: z.string().email(),
  age: z.number().min(0).max(150),
});

export const createUser = procedure
  .input(createUserSchema)
  .handler(async ({ input }) => {
    // input is automatically validated
    // TypeScript types are inferred from schema
  });
```

## API Endpoints

- **RPC Endpoint**: `/api/orpc`
- **OpenAPI Spec**: `/api/openapi` (when enabled)

## Error Handling

```typescript
import { ORPCError } from '@orpc/server';

export const getUser = procedure
  .input(z.object({ id: z.string() }))
  .handler(async ({ input, ctx }) => {
    const user = await ctx.prisma.user.findUnique({
      where: { id: input.id },
    });
    
    if (!user) {
      throw new ORPCError({
        code: 'NOT_FOUND',
        message: 'User not found',
      });
    }
    
    return user;
  });
```

## Documentation

- [ORPC Documentation](https://orpc.unnoq.com/)
- [Zod Documentation](https://zod.dev/)
- [OpenAPI Specification](https://swagger.io/specification/)